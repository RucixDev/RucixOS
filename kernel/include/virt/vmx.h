#ifndef VMX_H
#define VMX_H

#include "types.h"

 
#define VMX_SUCCESS 0
#define VMX_FAIL_VALID 1
#define VMX_FAIL_INVALID 2

 
#define X86_RFLAGS_CF (1 << 0)
#define X86_RFLAGS_PF (1 << 2)
#define X86_RFLAGS_ZF (1 << 6)

 
#define MSR_IA32_VMX_BASIC 0x480
#define MSR_IA32_VMX_PINBASED_CTLS 0x481
#define MSR_IA32_VMX_PROCBASED_CTLS 0x482
#define MSR_IA32_VMX_EXIT_CTLS 0x483
#define MSR_IA32_VMX_ENTRY_CTLS 0x484
#define MSR_IA32_VMX_MISC 0x485
#define MSR_IA32_VMX_CR0_FIXED0 0x486
#define MSR_IA32_VMX_CR0_FIXED1 0x487
#define MSR_IA32_VMX_CR4_FIXED0 0x488
#define MSR_IA32_VMX_CR4_FIXED1 0x489

 
enum vmcs_field {
     
    GUEST_ES_SELECTOR = 0x0800,
    GUEST_CS_SELECTOR = 0x0802,
    GUEST_SS_SELECTOR = 0x0804,
    GUEST_DS_SELECTOR = 0x0806,
    GUEST_FS_SELECTOR = 0x0808,
    GUEST_GS_SELECTOR = 0x080A,
    GUEST_LDTR_SELECTOR = 0x080C,
    GUEST_TR_SELECTOR = 0x080E,
    GUEST_INTR_STATUS = 0x0810,
    GUEST_PML_INDEX = 0x0812,

     
    HOST_ES_SELECTOR = 0x0C00,
    HOST_CS_SELECTOR = 0x0C02,
    HOST_SS_SELECTOR = 0x0C04,
    HOST_DS_SELECTOR = 0x0C06,
    HOST_FS_SELECTOR = 0x0C08,
    HOST_GS_SELECTOR = 0x0C0A,
    HOST_TR_SELECTOR = 0x0C0C,

     
    IO_BITMAP_A = 0x2000,
    IO_BITMAP_A_HIGH = 0x2001,
    IO_BITMAP_B = 0x2002,
    IO_BITMAP_B_HIGH = 0x2003,
    MSR_BITMAP = 0x2004,
    MSR_BITMAP_HIGH = 0x2005,
    VM_EXIT_MSR_STORE_ADDR = 0x2006,
    VM_EXIT_MSR_STORE_ADDR_HIGH = 0x2007,
    VM_EXIT_MSR_LOAD_ADDR = 0x2008,
    VM_EXIT_MSR_LOAD_ADDR_HIGH = 0x2009,
    VM_ENTRY_MSR_LOAD_ADDR = 0x200A,
    VM_ENTRY_MSR_LOAD_ADDR_HIGH = 0x200B,
    EXECUTIVE_VMCS_PTR = 0x200C,
    EXECUTIVE_VMCS_PTR_HIGH = 0x200D,
    TSC_OFFSET = 0x2010,
    TSC_OFFSET_HIGH = 0x2011,
    VIRTUAL_APIC_PAGE_ADDR = 0x2012,
    VIRTUAL_APIC_PAGE_ADDR_HIGH = 0x2013,
    EPT_POINTER = 0x201A,
    EPT_POINTER_HIGH = 0x201B,

     
    VMCS_LINK_POINTER = 0x2800,
    VMCS_LINK_POINTER_HIGH = 0x2801,
    GUEST_IA32_DEBUGCTL = 0x2802,
    GUEST_IA32_DEBUGCTL_HIGH = 0x2803,
    GUEST_IA32_PAT = 0x2804,
    GUEST_IA32_PAT_HIGH = 0x2805,
    GUEST_IA32_EFER = 0x2806,
    GUEST_IA32_EFER_HIGH = 0x2807,

     
    HOST_IA32_PAT = 0x2C00,
    HOST_IA32_PAT_HIGH = 0x2C01,
    HOST_IA32_EFER = 0x2C02,
    HOST_IA32_EFER_HIGH = 0x2C03,

     
    PIN_BASED_VM_EXEC_CONTROL = 0x4000,
    CPU_BASED_VM_EXEC_CONTROL = 0x4002,
    EXCEPTION_BITMAP = 0x4004,
    PAGE_FAULT_ERROR_CODE_MASK = 0x4006,
    PAGE_FAULT_ERROR_CODE_MATCH = 0x4008,
    CR3_TARGET_COUNT = 0x400A,
    VM_EXIT_CONTROLS = 0x400C,
    VM_EXIT_MSR_STORE_COUNT = 0x400E,
    VM_EXIT_MSR_LOAD_COUNT = 0x4010,
    VM_ENTRY_CONTROLS = 0x4012,
    VM_ENTRY_MSR_LOAD_COUNT = 0x4014,
    VM_ENTRY_INTR_INFO_FIELD = 0x4016,
    VM_ENTRY_EXCEPTION_ERROR_CODE = 0x4018,
    VM_ENTRY_INSTRUCTION_LEN = 0x401A,
    TPR_THRESHOLD = 0x401C,
    SECONDARY_VM_EXEC_CONTROL = 0x401E,

     
    GUEST_ES_LIMIT = 0x4800,
    GUEST_CS_LIMIT = 0x4802,
    GUEST_SS_LIMIT = 0x4804,
    GUEST_DS_LIMIT = 0x4806,
    GUEST_FS_LIMIT = 0x4808,
    GUEST_GS_LIMIT = 0x480A,
    GUEST_LDTR_LIMIT = 0x480C,
    GUEST_TR_LIMIT = 0x480E,
    GUEST_GDTR_LIMIT = 0x4810,
    GUEST_IDTR_LIMIT = 0x4812,
    GUEST_ES_AR_BYTES = 0x4814,
    GUEST_CS_AR_BYTES = 0x4816,
    GUEST_SS_AR_BYTES = 0x4818,
    GUEST_DS_AR_BYTES = 0x481A,
    GUEST_FS_AR_BYTES = 0x481C,
    GUEST_GS_AR_BYTES = 0x481E,
    GUEST_LDTR_AR_BYTES = 0x4820,
    GUEST_TR_AR_BYTES = 0x4822,
    GUEST_INTERRUPTIBILITY_INFO = 0x4824,
    GUEST_ACTIVITY_STATE = 0x4826,
    GUEST_SM_BASE = 0x4828,
    GUEST_SYSENTER_CS = 0x482A,

     
    HOST_IA32_SYSENTER_CS = 0x4C00,

     
    CR0_GUEST_HOST_MASK = 0x6000,
    CR4_GUEST_HOST_MASK = 0x6002,
    CR0_READ_SHADOW = 0x6004,
    CR4_READ_SHADOW = 0x6006,
    CR3_TARGET_VALUE0 = 0x6008,
    CR3_TARGET_VALUE1 = 0x600A,
    CR3_TARGET_VALUE2 = 0x600C,
    CR3_TARGET_VALUE3 = 0x600E,

     
    GUEST_CR0 = 0x6800,
    GUEST_CR3 = 0x6802,
    GUEST_CR4 = 0x6804,
    GUEST_ES_BASE = 0x6806,
    GUEST_CS_BASE = 0x6808,
    GUEST_SS_BASE = 0x680A,
    GUEST_DS_BASE = 0x680C,
    GUEST_FS_BASE = 0x680E,
    GUEST_GS_BASE = 0x6810,
    GUEST_LDTR_BASE = 0x6812,
    GUEST_TR_BASE = 0x6814,
    GUEST_GDTR_BASE = 0x6816,
    GUEST_IDTR_BASE = 0x6818,
    GUEST_DR7 = 0x681A,
    GUEST_RSP = 0x681C,
    GUEST_RIP = 0x681E,
    GUEST_RFLAGS = 0x6820,
    GUEST_PENDING_DBG_EXCEPTIONS = 0x6822,
    GUEST_SYSENTER_ESP = 0x6824,
    GUEST_SYSENTER_EIP = 0x6826,

     
    HOST_CR0 = 0x6C00,
    HOST_CR3 = 0x6C02,
    HOST_CR4 = 0x6C04,
    HOST_FS_BASE = 0x6C06,
    HOST_GS_BASE = 0x6C08,
    HOST_TR_BASE = 0x6C0A,
    HOST_GDTR_BASE = 0x6C0C,
    HOST_IDTR_BASE = 0x6C0E,
    HOST_IA32_SYSENTER_ESP = 0x6C10,
    HOST_IA32_SYSENTER_EIP = 0x6C12,
    HOST_RSP = 0x6C14,
    HOST_RIP = 0x6C16,

     
    VM_EXIT_REASON = 0x4402,
    VM_EXIT_INTR_INFO = 0x4404,
    VM_EXIT_INTR_ERROR_CODE = 0x4406,
    IDT_VECTORING_INFO = 0x4408,
    IDT_VECTORING_ERROR_CODE = 0x440A,
    VM_EXIT_INSTRUCTION_LEN = 0x440C,
    VMX_INSTRUCTION_INFO = 0x440E,
    EXIT_QUALIFICATION = 0x6400,
    IO_RCX = 0x6402,
    IO_RSI = 0x6404,
    IO_RDI = 0x6406,
    IO_RIP = 0x6408,
    GUEST_LINEAR_ADDRESS = 0x640A,
};

struct guest_regs {
    uint64_t r15;
    uint64_t r14;
    uint64_t r13;
    uint64_t r12;
    uint64_t r11;
    uint64_t r10;
    uint64_t r9;
    uint64_t r8;
    uint64_t rbp;
    uint64_t rdi;
    uint64_t rsi;
    uint64_t rdx;
    uint64_t rcx;
    uint64_t rbx;
    uint64_t rax;
};

int vmx_init(void);
int vmx_create_vm(void);
void vmx_launch(void);

#endif  
